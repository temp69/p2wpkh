<!DOCTYPE html>

<html>

<head>
    <title>Bitcoin paper wallet</title>
    <meta name="description" content="Create segregated witness (SegWit) Addresse in your browser.">
    <meta name="keywords" content="Bitcoin, SegWit Address">

    <style>
        body,
        html {
            padding: 12px;
            font-family: "Verdana", "sans-serif";
        }

        a:link {
            text-decoration: none;
        }

        a:visited {
            text-decoration: none;
        }

        #share {
            color: green;
            font-size: 28px;
            font-weight: bold;
        }

        #keep {
            color: red;
            font-size: 28px;
            font-weight: bold;
        }

        #entropyCanvas {
            display: none;
            margin: 12px;
			border: 2px dotted #CCCCCC;
			border-radius: 5px;
			cursor: crosshair;
        }

        #entropyRef, #printRef {
            border: 1px solid #0088ff;
            background-color: #0088ff;
            color: #fff;
            padding: 5px;
            cursor: pointer;
        }

        .hr {
            height: 6px;
            border: 0;
            box-shadow: inset 0 6px 6px -6px rgba(0, 0, 0, 1);
        }

        .btn {
            border-radius: 4px;
            background-color: #fff;
            padding: 7px;
            font-size: 21px;
            border: 1px solid #999;
            box-shadow: 0 6px 6px -6px rgba(0, 0, 0, 1);
        }

        .panel-primary {
            border: 2px solid #5DADE2;
            border-radius: 3px;
        }

        .panel-heading {
            background-color: #5DADE2;
            color: #fff;
            padding: 5px;
        }

        .panel-danger {
            border: 2px solid #EC7063;
            border-radius: 3px;
        }

        .panel-headingd {
            background-color: #EC7063;
            color: #fff;
            padding: 5px;
        }

        .panel-body {
            padding: 3px;
        }
    </style>

    <!-- jQuery -->
    <script src="js/jquery-3.2.1.min.js"></script>
    <!-- Bitcoinjs-lib -->
    <script src="js/bitcoinjs-lib-3.1.1.js"></script>
    <!-- big integer for mouse entropy -->
    <script src="js/metropy.js"></script>
    <!-- QRCode lib -->
    <script type="text/javascript" src="js/qrcode.js"></script>
    <!-- PDF printer -->
    <script src="js/html2pdf.bundle.min.js"></script>
</head>

<body>
    <!-- Generate / Print Buttons -->
    <div align="center">
        <br>
        <a href="#entropyRef"><button id="entropyRef" onClick="return btnCreate();" class="btn btn-primary">Generate
                Bitcoin Address</button></a>
        <button id="printRef" class="btn btn-primary">Print</button>
        <br>
    </div>

    <!-- Printable content -->
    <div id="content">
        <br>
        <hr class="hr">
        <br>

        <!-- Mouse/Touch entrophy canvas -->
        <div align="center">
            <canvas id="entropyCanvas" width="400" height="400"></canvas>
        </div>
        <div align="center" id="canvasCounter"></div>

        <table width="100%">
            <tr>
                <td width="100%" align="center"><span id="share"></span></td>
            </tr>
            <tr>
                <td align="center">
                    <div id="qrcode"></div>
                    <div id="swaddr"></div>
                </td>
            </tr>
            <td>
                <br>
                <hr class="hr">
                <br>
            </td>
            <tr>
                <td width="100%" align="center"><span id="keep"></span></td>
            </tr>
            <tr>
                <td align="center">
                    <div id="qrcodepk"></div>
                    <div id="swpk"></div>
                </td>
            </tr>
        </table>
    </div>

    <script>
        // Get a regular interval for drawing to the screen
        window.requestAnimFrame = (function (callback) {
            return window.requestAnimationFrame || 
                        window.webkitRequestAnimationFrame ||
                        window.mozRequestAnimationFrame ||
                        window.oRequestAnimationFrame ||
                        window.msRequestAnimaitonFrame ||
                        function (callback) {
                            window.setTimeout(callback, 1000/60);
                        };
        })();

        // Create the needed variables
        var bitcoinAddress = "";
        var mousePos = { x:0, y:0 };
        var lastPos = mousePos;        
        var entropy = "";
        // Create the canvas
        var canvas = document.getElementById('entropyCanvas');
        var c2d = canvas.getContext("2d");
        c2d.font = "12px Arial";
        c2d.strokeStyle = "#222222";
        c2d.lineWith = 2;

        function btnCreate() {
            // Show canvas
            $("#entropyCanvas").css("display", "block");
            // set html content empty
            $("#qrcode").html("");
            $("#swaddr").html("");
            $("#qrcodepk").html("");
            $("#swpk").html("");
            $("#share").html("");
            $("#keep").html("");
            // Clear canvas content
            clearCanvas();
            // Add some info text to canvas
            c2d.fillText("Touch / move mouse to generate random numbers", 20, 20);
            // Zero out entropy source
            entropy = "";
            // Empty bitcoinAddress
            bitcoinAddress = "";
            // Random startpoint in canvas
            mousePos = randomMousePos();
            lastPos = mousePos; 

            // Get mouse position while moving inside of the canvas
            function getMousePos(canvasDom, mouseEvent) {
                var rect = canvasDom.getBoundingClientRect();
                return {
                    x: mouseEvent.clientX - rect.left,
                    y: mouseEvent.clientY - rect.top
                };
            }

            // Get the position of a touch relative to the canvas
            function getTouchPos(canvasDom, touchEvent) {
                var rect = canvasDom.getBoundingClientRect();
                return {
                    x: touchEvent.touches[0].clientX - rect.left,
                    y: touchEvent.touches[0].clientY - rect.top
                };
            }            
            
            // Check if we are mobile, either mouse or touch events
            var touchOrMouse = isMobileDevice() ? 'touchmove' : 'mousemove';
            var getPosition = function(canvasDom, event) {
                if (isMobileDevice()) {
                    return getTouchPos(canvasDom, event);
                } else {
                    return getMousePos(canvasDom, event);
                }
            };

            canvas.addEventListener(touchOrMouse, function (evt) {
                // Append until a length of 8192    
                if (entropy.length < 8192) {
                    // mousePos = getMousePos(canvas, evt);
                    mousePos = getPosition.bind(null, canvas, evt)();
                    // console.log('Pos: ', mousePos.x, mousePos.y)
                    // Append mouse position to entropy source
                    entropy += mousePos.x + mousePos.y;
                    document.getElementById("canvasCounter").innerHTML = entropy.length + " / 8192";
                } else { // Length requirement met 
                    // Hide canvas
                    $("#entropyCanvas").css("display", "none");
                    $("#canvasCounter").html("");
                    // Create a key pair based on the 8192 random integers through sha256 hash with the addMouseEntropy function 
                    me.addMouseEntropy(entropy, bitcoin.networks.bitcoin, function (maddr, mpk) {
                        // PUBLIC INFO
                        bitcoinAddress = maddr;
                        document.getElementById('share').innerHTML = "OK TO SHARE"
                        document.getElementById("swaddr").innerHTML = "<br><div class='panel panel-primary'><div class='panel-heading'><h3 class='panel-title'>Bitcoin PUBLIC Key (Savings book)</h2></div><div class='panel-body'><b>" + maddr + "</b></div></div>";

                        // Blank out any existing qr code
                        document.getElementById("qrcode").innerHTML = "";
                        // Create new qrcode with segwit address
                        new QRCode(document.getElementById("qrcode"), maddr);

                        document.getElementById('keep').innerHTML = "KEEP PRIVATE"
                        document.getElementById("swpk").innerHTML = "<br><div class='panel panel-danger'><div class='panel-headingd'><h3 class='panel-title'>Bitcoin PRIVATE Key (Savings book password)</h2></div><div class='panel-body'><b>" + mpk + "</b></div></div>";

                        // Blank out any exisitng private key qr code
                        document.getElementById("qrcodepk").innerHTML = "";
                        // Create new qrcode with private key
                        new QRCode(document.getElementById("qrcodepk"), mpk);
                    });
                }
            }, false);
        }

        // Print button
        $('#printRef').click(function () {
            var element = document.getElementById('content');
            var options = {
                filename: bitcoinAddress || 'empty'
            }
            html2pdf(element, options);
        });

        // Draw to the canvas
        function renderCanvas() {
            c2d.moveTo(lastPos.x, lastPos.y);
            c2d.lineTo(mousePos.x, mousePos.y);
            c2d.stroke();
            lastPos = mousePos;
        }

        // Clear canvas
        function clearCanvas() {
            canvas.width = canvas.width;
        }
        
        // When moving into the canvas start randomly
        function randomMousePos() {
            var rect = canvas.getBoundingClientRect();
            return {
                x: Math.floor(Math.random() * rect.width),
                y: Math.floor(Math.random() * rect.height),
            };
        }

        // Allow for animation
        (function drawLoop () {
            requestAnimFrame(drawLoop);
            renderCanvas();
        })();

        // Check for mobile device
        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
        };

    </script>

</body>

</html>